#!/opt/common/CentOS_6-dev/python/python-2.7.10/bin/python

import argparse, os, sys, signal
import cmo
from cmo import workflow
import getpass

FW_LOG_LOC = "/ifs/res/pwg/logs/fireworks_workflows/"

if __name__ =='__main__':
    parser = argparse.ArgumentParser(description="restart watcher daemon")
    parser.add_argument('-f', action='store_true', help="force kill the previous watcher")
    parser.add_argument('-l', '--log-file', action="store", help="optional log file for daemon")
    args = parser.parse_args()
    if not args.log_file:
        args.log_file = os.path.join(FW_LOG_LOC, getpass.getuser(), "daemon.log")
    print("writing log to %s" % args.log_file, file=sys.stderr)
    dummy = workflow.Workflow([],{})
    if(args.f):
        db = workflow.DatabaseManager()
        #db.client.admin.authenticate("fireworks", "speakfriendandenter")
        pid = db.get_daemon_pid()
        if pid:
            print("Found process pid for Daemon: %s\nKilling..." % pid, file=sys.stderr)
            try:
                os.kill(pid,0)
            except OSError:
                print("PID No Longer Extant", file=sys.stderr)
            else:
                try:
                    os.kill(pid, signal.SIGKILL)
                except:
                    print("Something went wrong in process kill..l bailing out", file=sys.stderr)
                    sys.exit(1)
        #shit is removed and we didn't quit
            print("Removing database record!", file=sys.stderr)
            print(db.remove_daemon_pid(), file=sys.stderr)
    dummy.watcher_daemon(log_file=args.log_file)



